zephyr:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache npm yq
    - npm install -g @devcontainers/cli hjson
    # remove unnecessary mounts that cause issue in Gitlab
    - hjson -j .devcontainer/devcontainer.json | yq 'del(.mounts)' > .devcontainer/devcontainer.tmp
    - mv .devcontainer/devcontainer.tmp .devcontainer/devcontainer.json
  script:
    - devcontainer up --workspace-folder .
    - devcontainer exec --workspace-folder .
      --remote-env CI="$CI"
      --remote-env GITLAB_CI="$GITLAB_CI"
      --remote-env CI_COMMIT_SHA="$CI_COMMIT_SHA"
      --remote-env CI_JOB_NAME="$CI_JOB_NAME"
      --remote-env CI_COMMIT_REF_NAME="$CI_COMMIT_REF_NAME"
      --remote-env CI_COMMIT_TAG="$CI_COMMIT_TAG"
      --remote-env CI_JOB_URL="$CI_JOB_URL"
      --remote-env CI_COMMIT_MESSAGE="$CI_COMMIT_MESSAGE"
      --remote-env CI_PIPELINE_ID="$CI_PIPELINE_ID"
      --remote-env EMBEDOPS_API_REPO_KEY="$EMBEDOPS_API_REPO_KEY"
      ci/zephyr.sh
  dependencies: []
